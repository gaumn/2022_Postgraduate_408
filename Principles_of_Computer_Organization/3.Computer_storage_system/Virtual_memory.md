# 虚拟存储器

主存与联机工作的辅存共同构成了虚拟存储器，二者在硬件和系统软件的共同管理下工作。对应应用程序员而言，虚拟存储器是**透明的**。虚拟存储器具有主存的速度和辅存的容量，提高了存储系统的性价比。

## 虚拟存储器的基本概念

虚拟存储器将主存或辅存的地址空间统一编址，形成了一个庞大的地址空间，在这个空间内，用户可以自由编程，而不在乎实际的主存容量和存储在主存中实际的存放位置。

用户编程允许涉及的地址称为虚地址或逻辑地址，虚地址对应的存储空间称为虚拟空间或程序空间。实际的主存单元地址称为实地址或物理地址，实地址对应的是主存地址空间，也称实地址空间。虚地址比实地址要大得多。

CPU使用虚地址时，由辅存硬件找出虚地址和实地址之间的对应关系，并判断这个虚地址对应的存储单元内容是否已装入主存。若已在主存中，则通过地址变换，CPU可直接访问主存指示的实际单元；若不在主存中，则把包含这个字的一页或一段调入主存再由CPU访问。若主存已满，则采用替换算法置换主存中的一页或一段。

在实际的物理存储层次上，所编程序和数据在操作系统的管理下，先送入磁盘，然后操作系统将当前运行所需要的部分调入主存，供CPU使用，其余暂不运行的部分则留在磁盘中。

## 页式虚拟存储器

以页为基础单位的虚拟存储器称为页段式虚拟存储器。虚拟存储器与主存空间都被划分成同样大小的页，主存的页称为实页，虚存的页称为虚页。把虚拟地址分成两个字段：虚页号和页内地址。虚拟地址到物理地址的转换是由页表实现的。页表是一张存放在主存中的虚拟号和实页号的对照表，它记录程序的虚页调入主存时被安排在主存中的位置。页表一般长久地保存在内存中。

硬件实现：

| 有效位 | 脏位 | 引用位 | 物理页或磁盘地址 |
| ------ | ---- | ------ | ---------------- |

有效位也称为装入位，用来表示对应页面是否在主存中，若为1，则表示该虚拟页已从外存调入主存，此时页表项存放该页的物理页号；若为0，则表示没有调入主存，此时页表项可以存放该页的磁盘地址。

脏位也称为修改页，用来表示页面是否被修改过，虚拟机制中采用回写策略，利用脏位可判断替换时是否需要写回磁盘。

引用位也称使用位，用来配合替换策略进行设置，例如是否实现最先调入(FIFO位)或最近最少用(LRU位)策略等。

地址结构：

| 虚页号 | 页内地址 |
| ------ | -------- |

CPU执行指令时，需要先将虚拟地址转换为主存物理地址。每个进程都有一个页表基址寄存器，存放该进程的页表首地址，然后根据虚拟地址高位部分的虚拟号找到对应的页表项，若装入位为1，则取出物理页号，和虚拟地址低位部分的页内地址拼接，形成实际物理地址；若装入号为0，则说明缺页，需要操作系统进行缺页处理。

页式虚拟存储器的优点是：页面的长度固定，页表简单，调入方便。

缺点是：由于程序的不可能正好是页面的整数倍，最后一页的零头将无法利用而造成浪费，并且页不是逻辑上的独立实体，所以处理、保护和共享都不及段式虚拟存储器方便。

## 加快地址转换：快表(TLB[^1])

由于地址转换过程可知，访存时先访问一次主存去查页表，再访问主存才能取得数据。如果缺页，那么还要进行页面替换、页面修改等，因此采用虚拟存储机制后，访问主存的次数更多了。

依据程序执行的局部性原理，在一段时间内总是经常访问某些页时，若把对应的页表项存放在高速缓冲器组成的快表(TLB)中,则可以明显提高效率。想要地把放在主存中的页表称为慢表(Page)。在地址转换中，首先查找快表，若命中，则无须访问主存中的页表。

快表通常采用全相联或组相联方式。每个TLB项由页表项内容加上一个TLB标记段组成，TLB标记用来表示该页表项取自页表中的那个虚页号对应的页表项，因此TLB标记的内容在全相联方式下就是该页表项对应的虚页号；组相联方式下则是对应的虚页号的高位部分，而虚页号的低位部分用于选择TLB组的组索引。

查找时，快表和慢表也可以同时进行，若快表中有此虚页号，则能很快地找到对应的实页号，并使慢表的查找作废，从而就能做到虽采用虚拟存储器但访问主存速度几乎没有下降。

TLB缺失既可以用硬件又可以用软件来处理，比如操作系统有专门的"TLB缺少异常处理"程序。

## 段式虚拟存储器

段式虚拟存储器中的段是按照程序的逻辑结构划分，各个段的长度因程序而异。把虚拟地址分成两个部分：段号和段内地址。虚拟地址到实地址之间的变换是由段表来实现的。段表是程序的逻辑段和主存中存放位置的对照表。段表的每行记录与某个段对应的段号、装入位、段起点和段长等信息。由于段的长度可变，所以段表中要给出各段的起始地址和段的长度。

地址结构

| 段号 | 段内地址 |
| ---- | -------- |

CPU根据虚拟地址访存时，首先根据段号和段表基地址(段表基址寄存器内存储的)拼接成对应的段表行，然后根据该段表行的装入位判断该段表行是否已调入主存。若已调入主存时，从段表读出该段在主存中的起始地址，与段内地址(偏移量)相加，得到对应的主存实地址。

段式虚拟存储器的优点是段的分界与程序的自然分界相对应，因而具有逻辑独立性，使它易于编译、管理、修改和保护，也便于多道程序的共享；缺点是因为段长度可变，分配空间不便，容易在段间留下碎片，不好利用，造成浪费。

## 段页式虚拟存储器

把程序按逻辑结构分段，每段再划分为固定大小的页，主存空间也划分为大小相同的页，程序对主存的调入、调出仍以页为基本传送单位，这样的虚拟存储器称为段页式虚拟存储器。在段页式虚拟存储器中，每个程序对应一个段表，每段对应一个页表，段的长度必须是页的整数倍，段的起点必须是某一页的起点。

虚地址分为段号、段内页号、页内地址三部分。CPU根据虚地址访存时，首先根据段号得到段表地址；然后从段表中取出该段的页表起始地址，与虚地址段内页号合成，得到页表地址；最后从页表中取出实页号，与页内地址拼接形成主存实地址。

段页式虚拟存储器的优点是，兼具页式和段式虚拟存储器的优点，可以按照段实现共享和保护。缺点是在地址变换过程中需要两次查表，系统开销较大。

## 虚拟存储器与Cache的比较

### 相同之处

+ 最终目标都是为了提高系统性能，两者都有容量、速度、价格的梯度
+ 都把数据划分为小信息块，并作为基本的传递单位，虚拟系统的信息块更大
+ 都有地址的映射、替换算法、更新策略等
+ 依据程序的局部性原理应用”快速缓存的思想“，将活跃的数据放在相对高速的部件中。

### 不同之处

+ Cache主要解决系统速度，而虚拟存储器却是为了解决主存容量
+ Cache全由硬件实现，是硬件存储器，对所有程序员透明；而虚拟存储器由OS和硬件共同实现，是逻辑上的存储器，对系统程序员不透明，却对应用程序员透明。
+ 对不命中性能的影响，因为CPU速度约是Cache的10倍，主存的速度约为硬盘的100倍以上，因此虚拟存储器系统不命中时对系统性能的影响更大。
+ CPU与Cache和主存都建立了直接访问的通路，而辅存与CPU没有直接通路。也就是说在Cache中不命中时主存能与CPU直接通信，同时将数据调入Cache中；而虚拟存储器系统不命中时，只能先由硬盘调入主存，而不能直接和CPU通信。











































[^1]:Translation lookaside buffer，即旁路转换缓冲，或称为页表缓冲



